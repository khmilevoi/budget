<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Калькулятор долгов</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input, button { margin: 5px 0; }
  .transactions { margin-top: 20px; }
  table { border-collapse: collapse; width: 100%; }
  td, th { border: 1px solid #ccc; padding: 5px; }
</style>
</head>
<body>
<h1>Калькулятор долгов</h1>
<form id="addForm">
  <label>Кто платил: <input id="payer" required></label><br>
  <label>Сумма: <input id="amount" type="number" step="0.01" required></label><br>
  <label>Участники (через запятую): <input id="participants" required></label><br>
  <button type="submit">Добавить</button>
</form>
<div class="transactions">
  <h2>Транзакции</h2>
  <table id="txTable">
    <thead><tr><th>Платил</th><th>Сумма</th><th>Участники</th><th></th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<div class="import-export">
  <h2>Импорт/экспорт</h2>
  <input type="file" id="csvFile" accept=".csv">
  <button id="exportBtn">Экспорт CSV</button>
</div>
<div id="result">
  <h2>Расчёт долгов</h2>
  <pre id="debts"></pre>
</div>
<script>
const STORAGE_KEY = 'transactions';

function loadTransactions() {
  const data = localStorage.getItem(STORAGE_KEY);
  return data ? JSON.parse(data) : [];
}

function saveTransactions(txs) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(txs));
}

function renderTransactions() {
  const tbody = document.querySelector('#txTable tbody');
  tbody.innerHTML = '';
  const txs = loadTransactions();
  txs.forEach((tx, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${tx.payer}</td><td>${tx.amount.toFixed(2)}</td><td>${tx.participants.join(', ')}</td><td><button data-idx="${idx}">X</button></td>`;
    tbody.appendChild(tr);
  });
}

function calculateDebts() {
  const txs = loadTransactions();
  const balances = {};
  txs.forEach(tx => {
    const share = tx.amount / tx.participants.length;
    tx.participants.forEach(p => {
      balances[p] = (balances[p] || 0) - share;
    });
    balances[tx.payer] = (balances[tx.payer] || 0) + tx.amount;
  });
  const debtors = Object.keys(balances)
    .filter(n => balances[n] < -0.01)
    .map(n => ({ name: n, amount: -balances[n] }));
  const creditors = Object.keys(balances)
    .filter(n => balances[n] > 0.01)
    .map(n => ({ name: n, amount: balances[n] }));
  const settlements = [];
  let i = 0,
    j = 0;
  while (i < debtors.length && j < creditors.length) {
    const d = debtors[i];
    const c = creditors[j];
    const pay = Math.min(d.amount, c.amount);
    settlements.push(`${d.name} должен(а) ${c.name} ${pay.toFixed(2)}`);
    d.amount -= pay;
    c.amount -= pay;
    if (d.amount < 0.01) i++;
    if (c.amount < 0.01) j++;
  }
  document.getElementById('debts').textContent = settlements.join('\n');
}

document.getElementById('addForm').addEventListener('submit', e => {
  e.preventDefault();
  const payer = document.getElementById('payer').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  const participants = document
    .getElementById('participants')
    .value.split(',')
    .map(s => s.trim())
    .filter(Boolean);
  const txs = loadTransactions();
  txs.push({ payer, amount, participants });
  saveTransactions(txs);
  e.target.reset();
  renderTransactions();
  calculateDebts();
});

document.querySelector('#txTable tbody').addEventListener('click', e => {
  if (e.target.tagName === 'BUTTON') {
    const idx = parseInt(e.target.dataset.idx, 10);
    const txs = loadTransactions();
    txs.splice(idx, 1);
    saveTransactions(txs);
    renderTransactions();
    calculateDebts();
  }
});

function exportCSV() {
  const txs = loadTransactions();
  const header = 'payer,amount,participants\n';
  const lines = txs.map(t => `${t.payer},${t.amount},${t.participants.join(';')}`);
  const blob = new Blob([header + lines.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'transactions.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function handleImport(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result.trim();
    const lines = text.split(/\r?\n/).slice(1);
    const txs = loadTransactions();
    lines.forEach(line => {
      if (!line) return;
      const [payer, amount, parts] = line.split(',');
      txs.push({
        payer: payer.trim(),
        amount: parseFloat(amount),
        participants: parts
          .split(';')
          .map(s => s.trim())
          .filter(Boolean)
      });
    });
    saveTransactions(txs);
    renderTransactions();
    calculateDebts();
  };
  reader.readAsText(file);
}

window.addEventListener('load', () => {
  renderTransactions();
  calculateDebts();
  document.getElementById('exportBtn').addEventListener('click', exportCSV);
  document.getElementById('csvFile').addEventListener('change', e => {
    handleImport(e.target.files[0]);
    e.target.value = '';
  });
});
</script>
</body>
</html>
